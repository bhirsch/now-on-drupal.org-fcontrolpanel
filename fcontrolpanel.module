<?php
/**
 * @file
 *  
 */
 
//--------------------------------//
// core Drupal hooks              //
//--------------------------------//

/**
 * Implementation of hook_help()
 */
function fcontrolpanel_help($path, $arg) {
  if ($path == 'admin/help#fcontrolpanel') {
    $txt = 'Features Control Panel provides a.... [FINISH HELP TEXT] '; // TODO
    $output = t($txt);
    return $output;
  }
}
 
/**
 * Implementation of hook_menu().
 */
function fcontrolpanel_menu() {
  $items['admin/build/fcontrolpanel/%/export'] = array(
    'title' => 'export',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('fcontrolpanel_export_fcontrol', 3),
    'access arguments' => array('fcontrolpanel export permission'),
    'type' => menu_callback,
  );
  $items['admin/fcontrolpanel'] = array(
    'title' => 'Features Control Panel',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('fcontrolpanel_page'),
    'access arguments' => array('access features control panel'),
    'file' => 'fcontrolpanel.page.inc',
    'type' => menu_callback,
  );

  return $items;
}

/**
 * Implementation of hook_perm().
 */
function fcontrolpanel_perm() {
  return array('access features control panel');
}

/*
function fcontrolpanel_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'ctools_export_ui_list_form') {
    dsm($form);  
  }
}
// */

/**
 * Implementation of hook_theme().
 */
function fcontrolpanel_theme() {
  return array(
    'fcontrolpanel_fcontrol' => array(
      'arguments' => array('element' => NULL),
    ),
    'fcontrolpanel_admin_block' => array(
      'arguments' => array('package' => NULL),
    ),
  );
}


/**
 * Implementation of hook_block().
 */
function fcontrolpanel_block($op = 'list', $delta = 0, $edit = array()) {
  $packages = fcontrolpanel_get_packages();
  if ($op == 'list') {
    foreach($packages as $n => $package) {
      $blocks[$n]['info'] = $package['package_title'];  
      $blocks[$n]['admin'] = TRUE;
    }  
    return $blocks;
  } else if ($op == 'view') {
    $package = $packages[$delta];
    $block['subject'] = t($package['package_title']);
    $block['content'] = theme('fcontrolpanel_admin_block', $package);
    return $block;
  }
}

/**
 * Implement theme_fcontrolpanel_admin_block. 
 * 
 * Each package (feature set) gets a corresponding block
 * for the admin module's admin toolbar.
 * 
 * @param $package
 *  array, all the fcontrols for the package.
 * 
 * @return $output
 *  string, HTML for block content.
 */
function theme_fcontrolpanel_admin_block($package) {
  $output = '';
  $output.= '<ul class="menu">';

  foreach($package['fcontrols'] as $fcontrol) {
    $txt = t($fcontrol->title);
    $path = $fcontrol->path;
    $query = $fcontrol->query;
    $perm = ($fcontrol->permission) ? $fcontrol->permission : 'access features control panel';
    if (user_access($perm)) {
      $link = l($txt, $path, array('query' => $query));
      $output .= '<li class="leaf">'. $link .'</li>';
    }
  }

  $output .= '</ul>';
  
  return $output;
}

//----------------------------------------------//
// fcontrolpanel                                //
//----------------------------------------------//

/**
 * @return $packages
 *  array, fcontrols organized by package
 *
 * $packages[$i]['package_name'] = package name
 * $packages[$i]['package_title'] = $package_title; 
 * $packages[$i]['fcontrols'][$fcontrol]
 */
function fcontrolpanel_get_packages() {
  $fcontrols = ctools_export_load_object('fcontrolpanel_fcontrol');
  // Make a unique list of packages;
  foreach($fcontrols as $fcontrol) {
    $package_title = $fcontrol->package;
    $package = strtolower(preg_replace('/[^a-zA-Z0-9-]+/', '-', $package_title));
    $list[$package] = $package_title;
  }
  // Number packages.
  $packages = array();
  $i = 0;
  foreach($list as $package => $package_title) {
    $packages[$i]['package_name'] = $package;
    $packages[$i]['package_title'] = $package_title;
    // Organize fcontrols by package.
    foreach($fcontrols as $fcontrol) {
      if($fcontrol->package == $package_title) {
        $packages[$i]['fcontrols'][] = $fcontrol;
      } 
    }
    $i++;
  }
  
  return $packages;
}

//--------------------------------------------------/
// Ctools plugin                                    /
//--------------------------------------------------/
/**
 * Implmenentation of hook_ctools_plugin_directory.
 */
function fcontrolpanel_ctools_plugin_directory($module, $plugin) {
  if ($plugin == 'export_ui') {
    return 'plugins/'. $plugin;
  }
}

/**
* Implementation of hook_ctools_plugin_api().
*
* Tell CTools that we support the default_mymodule_presets API.
*/
function fcontrolpanel_ctools_plugin_api($owner, $api) {
  if ($owner == 'fcontrolpanel' && $api == 'default_fcontrolpanel_fcontol') {
    return array('version' => 1);
  }
}

/**
 * Implementation of default hook, hook_default_mymodule_myobj().
 *
 * Provide a couple of default presets.
 *
 * Note: This function name is defined in .install file,
 *   'default hook' => 'default_mymodule_myobj',  // Function hook name.
 */ 
// TODO figure out why this doesn't seem to work.
function fcontrolpanel_default_fcontrolpanel_fcontrol() {
  $export = array();

  $export = array();
  $fcontrol = new stdClass;
  $fcontrol->disabled = FALSE; /* Edit this to true to make a default fcontrol disabled initially */
  $fcontrol->api_version = 1;
  $fcontrol->package = 'example';
  $fcontrol->title = 'This is an example';
  $fcontrol->name = 'example';
  $fcontrol->path = 'admin/example';
  $fcontrol->query = 'x=y&a=b';
  $fcontrol->description = 'This is an example control for the features control panel.';
  $fcontrol->video_title = 'Instructional Video';
  $fcontrol->video = '<embed>YouTube video here.</embed>';
  $fcontrol->instructions_title = '3 Steps to Blah De Blah';
  $fcontrol->instructions = 'Step 1. blee. Step 2. Blah. Step 3. Blo.';

  $export['example'] = $fcontrol;
  return $export;
}


//--------------------------------------------------/
// Ctools export hooks                              /
//--------------------------------------------------/

/**
 * Export a myobj and display it in a form.
 * 
 * @param $name
 *  string, unique id for object
 */
function fcontrolpanel_export_fcontrol(&$form_state, $name) {
  $obj = fcontrolpanel_fcontrol_load($name);
  drupal_set_title(check_plain($obj->description));
  $code = fcontrolpanel_fcontrol_export($obj);
  $lines = substr_count($code, "\n");

  $form['export'] = array(
    '#title' => t('Export data'),
    '#type' => 'textarea',
    '#value' => $code,
    '#rows' => $lines,
    '#description' => t('Copy the export text and paste it into another myobj using the import function.'),
  );
  return $form;
}

/**
 * Load a single myobj.
 */
function fcontrolpanel_fcontrol_load($name) {
  ctools_include('export');
  $result = ctools_export_load_object('fcontrolpanel_fcontrol', 'names', array($name)); 
  if (isset($result[$name])) {
    return $result[$name];
  }
}

/**
 * Export a myobj.
 */
function fcontrolpanel_fcontrol_export($obj, $indent = '') {
  ctools_include('export');
  $output = ctools_export_object('fcontrolpanel_fcontrol', $obj, $indent);
  return $output;
}

/**
 * Save a single myobj.
 */
// TODO 
function fcontrolpanel_fcontrol_save(&$myobj) {
    $update = (isset($myobj->oid) && is_numeric($myobj->oid)) ? array('oid') : array();
      return drupal_write_record('myobj', $myobj, $update);
}



//-------------------------------------------------/
// Features hooks                                  /
//-------------------------------------------------/
/**
 * Implementation of hook_features_api().
 */
// TODO 

/**
 * Implementation of hook_features_export().
 */
// TODO 

/**
 * Implementation of hook_features_export_render().
 */
// TODO 

/**
 * Implementation of hook_features_export_options().
 */
// TODO 

/**
 * Implementation of hook_features_revert().
 */
// TODO 

